"""
Stytch Session Authentication for Django REST Framework
Project: {{projectName}}
"""

from django.conf import settings
from rest_framework import authentication, exceptions
from stytch import Client as StytchClient


class StytchSessionAuthentication(authentication.BaseAuthentication):
    """
    Stytch Session Authentication class for DRF.

    Validates session tokens using Stytch SDK and extracts user information.
    """

    def authenticate(self, request):
        """
        Authenticate the request and return a tuple of (user, token).
        """
        auth_header = authentication.get_authorization_header(request)

        if not auth_header:
            return None

        try:
            auth_parts = auth_header.decode('utf-8').split()
        except UnicodeDecodeError:
            raise exceptions.AuthenticationFailed('Invalid token header encoding')

        if len(auth_parts) != 2 or auth_parts[0].lower() != 'bearer':
            return None

        token = auth_parts[1]

        try:
            stytch_response = self._verify_token(token)
        except Exception as e:
            raise exceptions.AuthenticationFailed(f'Token validation failed: {str(e)}')

        # Create a simple user object from the Stytch response
        user = StytchUser(stytch_response)

        return (user, token)

    def _verify_token(self, token):
        """
        Verify Stytch session token and return the response.
        """
        stytch_project_id = getattr(settings, 'STYTCH_PROJECT_ID', None)
        stytch_secret = getattr(settings, 'STYTCH_SECRET', None)

        if not stytch_project_id:
            raise exceptions.AuthenticationFailed('STYTCH_PROJECT_ID not configured')
        if not stytch_secret:
            raise exceptions.AuthenticationFailed('STYTCH_SECRET not configured')

        # Initialize Stytch client
        client = StytchClient(
            project_id=stytch_project_id,
            secret=stytch_secret,
        )

        # Authenticate session
        response = client.sessions.authenticate(session_token=token)

        if response.status_code != 200:
            raise exceptions.AuthenticationFailed('Invalid session token')

        return response


class StytchUser:
    """
    Simple user class that represents a Stytch authenticated user.
    """

    def __init__(self, stytch_response):
        self.stytch_response = stytch_response
        self.session = stytch_response.session
        self.stytch_user = stytch_response.user

        self.id = self.session.user_id

        # Extract email from user object
        self.email = None
        if self.stytch_user.emails and len(self.stytch_user.emails) > 0:
            self.email = self.stytch_user.emails[0].email

        # Extract name from user object
        self.first_name = getattr(self.stytch_user.name, 'first_name', None) if self.stytch_user.name else None
        self.last_name = getattr(self.stytch_user.name, 'last_name', None) if self.stytch_user.name else None

        # Extract custom claims
        self.claims = self.session.custom_claims or {}

        # Extract tenant ID if available (for B2B apps)
        tenant_claim_key = getattr(settings, 'STYTCH_TENANT_CLAIM_KEY', 'organization_id')
        self.tenant_id = self.claims.get(tenant_claim_key)

        self.is_authenticated = True
        self.is_active = True

        # Extract roles from custom claim
        role_claim_key = getattr(settings, 'STYTCH_ROLE_CLAIM_KEY', '{{roleClaimKey}}')
        self.roles = self.claims.get(role_claim_key, [])
        if not isinstance(self.roles, list):
            self.roles = [self.roles]

    def __str__(self):
        return self.email or self.id

    @property
    def is_anonymous(self):
        return False

    def has_role(self, role):
        """Check if user has a specific role."""
        return role in self.roles

    def has_any_role(self, roles):
        """Check if user has any of the specified roles."""
        return any(role in self.roles for role in roles)
